# Ink

Ink is a workflow for using [Terraform](https://www.terraform.io) with git.

## Why use Ink

Terraform is, out-of-the-box, a great tool for managing infrastructure using
code. However, finding a workflow for collaboration can be a challenge.

You should already be tracking your terraform code and configs in revision
control like git, so why not also use it to manage the workflow and
collaboration?

## How Ink Works

Ink is based on git repositories and branches.

Any state generated by Terraform or by your commands will be tracked inside the
repository alongside you code.  The revision history of the repository then
truly becomes the revision history of your infrastructure.

Each Ink "stack" is a branch in a repository. For example, let's say you
create a new stack based on your octobatman repository:

    $ ink init git@github.com:github/octobatman.git
    octobatman-d88f7

If you check your repository, you'll see one very important thing: A new branch
called `ink-octobatman-d88f7`

Now when we start making use of this stack, we're actually just running
terraform and making changes in our branch.

    $ ink apply octobatman-d88f7

This command will:

  1. Verify our branch `ink-octobatman-d88f7` is at HEAD
  1. Execute `terraform apply`
  1. Commit any changes and push to origin.


The awesome part about having your infrastrucuture automated with a tool like
terraform is you can easily blow it away and create it again.

    $ ink destroy octobatman-d88f7

## Environment

When initializing an ink stack you can provide arguments. These will be
persisted in git and provided to ink scripts when executed. For example:

    $ ink init git@github.com:github/octobatman.git my_var=foo
    octobatman-d88f7

You can then access variables inside your terraform configs as they are passed
to terraform as environment variables like `TF_VAR_my_var`.

There are also some useful built-in variables that can be used by your configurations:

  * `ink_name` - The name of your ink stack, for example `octobatman-d88f7` in the above examples.
  * `ink_id` - The uniquely generated portion of the name, for example `d88f7` in the above examples.

## Custom Name

You can customize the naming by specifying the special `ink_id` variable.

    $ ink init git@github.com:github/octobatman.git ink_id=production
    octobatman-production

Or you can completely override the naming system by using the above envionment facilities

    $ ink init git@github.com:github/octobatman.git ink_name=alfred
    alfred

## Command Reference

While ink is a wrapper around terraform, not all commands are implemented. They
don't always make sense in a remote context.

  * `ink init <git repository>` - Clone a repository and configure a new ink branch.
  * `ink apply <name>` - Run `terraform apply`. NOTE: We automatically disable refreshing.
  * `ink refresh <name>` - Run `terraform refresh`
  * `ink plan <name>` - Run `terraform plan`
  * `ink output <name>` - Run `terraform output`
  * `ink list` - Show available ink branches

## Scripts and Extensions

Ink supports user-defined scripts, similiar to the [Scripts to Rule Them All](https://github.com/github/scripts-to-rule-them-all) Concept.

  * `script/setup` - If it exists and is executable, ink will automatically execute it during `init`
  * `script/update` - If exists and is executable, ink will automatically execute it before anything else.


## Installation

You'll likely want to run ink on some coordinator host in your production
network (meaning, not locally).

All you need is a workspace for ink to clone git repositories and some
environment variables needed for your scripts to do the work they need.

Create a space like `/var/lib/ink`, and make sure you always run ink inside
this path.

## Development

We Test.
Build Status: [![Circle CI](https://circleci.com/gh/rhettg/ink.svg?style=svg)](https://circleci.com/gh/rhettg/ink)

### Local Installation

Ok fine, you can run this on your laptop in your development environment if you want.

The difference is going to be you are going to manage the clone of the repo
yourself. Ink is also going to ignore if the repo has a remote at all.

Run ink from inside the repository starting with:

    $ ink init .


### TODO

  - [ ] More helpful ink-env vars
  - [ ] TTL
  - [ ] Annotations, like `-m "more instances"`
  - [ ] Syntax for non-master branches as origin
